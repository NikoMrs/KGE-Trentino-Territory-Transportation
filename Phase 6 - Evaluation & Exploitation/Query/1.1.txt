PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
PREFIX etype: <http://knowdive.disi.unitn.it/etype#>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>

# 1.1 (Sara): Which buses and trains can I take to go from Trento Station to the Department of Economics between 8:00 and 9:00?
# Trento Station lat:46.071772 lon:11.1196671
# Department of Economics lat:46.0661215 lon:11.117906

select ?trip ?line_name ?departure_time where { 

    # Donnect the trip with two of it's departure events, one for the departure and the other for the arrival
    ?trip etype:Contains ?departure_event, ?arrival_event .
    
    # Select all the stops with it's date and filter mantaining only the ones near the wanted locations
	?departure_stop etype:name ?departure_name ;
    	  etype:latitude ?departure_latitude ;
		  etype:longitude ?departure_longitude .
          
    ?arrival_stop etype:name ?arrival_name ;
    	  etype:latitude ?arrival_latitude ;
		  etype:longitude ?arrival_longitude .
    
    FILTER (ABS(xsd:float(?departure_latitude) - 46.071772) <= 0.0005 && ABS(xsd:float(?departure_longitude) - 11.1196671) <= 0.0005)
    FILTER (ABS(xsd:float(?arrival_latitude) - 46.0661215) <= 0.002 && ABS(xsd:float(?arrival_longitude) - 11.117906) <= 0.002)
    
    # Connect the previously defined stops with the corresponding stop event
	?departure_stop etype:is_location_for ?departure_event .
    ?departure_event etype:sequence_number ?departure_sequence ;
            		 etype:arrival_time ?departure_time .
            
    ?arrival_stop etype:is_location_for ?arrival_event .
    ?arrival_event etype:sequence_number ?arrival_sequence ;
            	   etype:arrival_time ?arrival_time .
    			  
    # We are mantaining only the trips that are available in the current day of the week
    ?schedule etype:is_followed_by ?trip .
    ?schedule etype:byDay ?days .
    FILTER(CONTAINS(STR(?days), "monday"))
    
    # If the specified date is present is special schedule means that the service isn't available
    ?schedule etype:refers_to ?special_schedule .
    ?special_schedule etype:date ?date .
    FILTER((STR(?days) != "20250120" )) #YYYY-MM-DD
    
    ?line etype:composed_of ?trip .
    ?line etype:line_short_name ?line_name .
    
    # We want the sequence number of the departure stop to be lower with respect of the arrival stop,
    # in this way we are defining a specific direction of the trip
    FILTER(str(?arrival_sequence) > str(?departure_sequence))

    # We filter with respect to the wanted departure time
    FILTER(STR(?departure_time) >= "08:00:00" && STR(?departure_time) <= "09:00:00")
    

    
    
} GROUP BY ?trip ?line_name ?departure_time ORDER BY ?departure_time
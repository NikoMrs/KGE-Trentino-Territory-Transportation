PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
PREFIX etype: <http://knowdive.disi.unitn.it/etype#>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>

# 3.2 (Sara): If I get on bus line 5 at “Povo Salé” stop at 12:03, when can I expect to arrive at the “Port'aquila” stop?

select ?departure_name ?departure_time ?arrival_name ?arrival_time (((xsd:integer(SUBSTR(?arrival_time, 1, 2)) * 60 + 
         xsd:integer(SUBSTR(?arrival_time, 4, 2)) + 
         xsd:integer(SUBSTR(?arrival_time, 7, 2))) -
        (12 * 60 + 3)) AS ?time_in_minutes) where {

    # We consider only the busses 3 and 5
    ?line etype:line_short_name ?line_name .
    ?line etype:line_type ?line_type .
    FILTER(STR(?line_type) = "3" && STR(?line_name) = "5")
    
    # We connect lines and trips
    ?line etype:composed_of ?trip .
    
    # We specify that trip contains the departure and arrival event
    ?trip etype:Contains ?departure_event ;
          etype:Contains ?arrival_event .
    
    # We mantain only the trips that are returning to the station
    ?trip etype:trip_direction ?trip_direction .
    FILTER(STR(?trip_direction) = "1")
    
   	# We connect the previously defined departure event with the corresponding stops
    # then we filter for the departure time  
	?departure_stop etype:is_location_for ?departure_event .
    ?departure_event etype:sequence_number ?departure_sequence ;
            		 etype:arrival_time ?departure_time .
    FILTER(STR(?departure_time) = "12:03:00")
    
    # Filter the departure stop by name
	?departure_stop etype:name ?departure_name .
    FILTER(STR(?departure_name) = "Povo Salé")
	
    # Filter the arrival stop by name
    ?arrival_stop etype:name ?arrival_name .
    FILTER(CONTAINS(STR(?arrival_name), "Port'aquila"))
    
    # We are mantaining only the trips that are available in the current day of the week
    ?schedule etype:is_followed_by ?trip .
    ?schedule etype:byDay ?days .
    FILTER(CONTAINS(STR(?days), "monday"))

    # We connect the previously defined arrival event with the corresponding stops
    ?arrival_stop etype:is_location_for ?arrival_event .
    ?arrival_event etype:sequence_number ?arrival_sequence ;
            	   etype:arrival_time ?arrival_time .

} limit 1
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
PREFIX etype: <http://knowdive.disi.unitn.it/etype#>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>

# 6.2 (Andrea): How many stops separate the area of Piazza Dante from the Department of Economics on public transport lines?
# Piazza Dante lat:46.071772 lon:11.1196671
# Department of Economics lat:46.0661215 lon:11.117906
# For every line this query returns the number of stops between the two specified locations

SELECT distinct ?line_name (ABS(xsd:integer(?arrival_sequence) - xsd:integer(?departure_sequence)) AS ?n_stops)
WHERE {
    
    # Connect the lines and trips
    ?line etype:composed_of ?trip ;
          etype:line_short_name ?line_name .
    
    # The trip contains the departure and arrival stop events
    ?trip etype:Contains ?departure_event, ?arrival_event .
    
    # We filter for the desired direction
    ?trip etype:trip_direction ?trip_direction ;
    FILTER(STR(?trip_direction) = "0") .
    
    # We ensure that the departure and arrival stops are on the same trip and refer to the respective stop events,
    # the stops are also filtered by location
    ?departure_stop etype:is_location_for ?departure_event ;
        	  		etype:latitude ?departure_latitude ;
		  			etype:longitude ?departure_longitude .
    FILTER (ABS(xsd:float(?departure_latitude) - 46.071772) <= 0.0005 && ABS(xsd:float(?departure_longitude) - 11.1196671) <= 0.0005)
    
    ?arrival_stop etype:is_location_for ?arrival_event ;
        	  	  etype:latitude ?arrival_latitude ;
		  		  etype:longitude ?arrival_longitude .
    FILTER (ABS(xsd:float(?arrival_latitude) - 46.0661215) <= 0.002 && ABS(xsd:float(?arrival_longitude) - 11.117906) <= 0.002)
    
    # Get the sequence numbers for stops
    ?departure_event etype:sequence_number ?departure_sequence .
    ?arrival_event etype:sequence_number ?arrival_sequence .

    FILTER(str(?arrival_sequence) > str(?departure_sequence))
}

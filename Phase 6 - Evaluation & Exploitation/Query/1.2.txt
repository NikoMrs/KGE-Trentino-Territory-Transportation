PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
PREFIX etype: <http://knowdive.disi.unitn.it/etype#>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>

# 1.2 (Marco): What is the arrival time of the next bus from the ”Povo Valoni” stop heading downtown?

select ?line_name ?departure_time where {

    # We consider only the bus lines
    ?line etype:line_short_name ?line_name .
    ?line etype:line_type ?line_type .
    FILTER(STR(?line_type) = "3")
    
    # We connect lines and trips
    ?line etype:composed_of ?trip .
    
    # We maintain only the trips that are heading downtown specifying the direction
    ?trip etype:Contains ?departure_event .
    ?trip etype:trip_direction ?trip_direction .
    FILTER(STR(?trip_direction) = "1")
    
   	# Secelts all the stops and stop events
	?departure_stop etype:is_location_for ?departure_event .
    ?departure_event etype:sequence_number ?departure_sequence ;
            		 etype:arrival_time ?departure_time .
    
    # We filter the stops mantaining only the "Povo Valoni"
	?departure_stop etype:name ?departure_name ;
    FILTER(STR(?departure_name) = "Povo Valoni")

    # We are mantaining only the trips that are available in the current day of the week
    ?schedule etype:is_followed_by ?trip .
    ?schedule etype:byDay ?days .
    FILTER(CONTAINS(STR(?days), "monday"))
    
    # If the specified date is present is special schedule means that the service isn't available
    ?schedule etype:refers_to ?special_schedule .
    ?special_schedule etype:date ?date .
    FILTER((STR(?days) != "20250120" )) #YYYY-MM-DD
   	
    # We want all the trips after a specified time
    FILTER(STR(?departure_time) >= "08:00:00")
    
} GROUP BY ?line_name ?departure_time ORDER BY ?departure_time limit 100